generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================== ENUMS =====================

enum Role {
  FACTORY
  SUPPLIER
  ADMIN
}

enum UserStatus {
  PENDING
  ACTIVE
  BLOCKED
}

enum DemandStatus {
  OPEN
  IN_NEGOTIATION
  CLOSED
  CANCELLED
}

enum QuoteStatus {
  PENDING
  ANSWERED
  ACCEPTED
  REJECTED
}

enum OrderStatus {
  CONFIRMED
  PREPARING
  IN_TRANSIT
  DELIVERED
}

enum NotificationType {
  NEW_QUOTE
  QUOTE_ANSWERED
  ORDER_STATUS
  ML_ALERT
}

// ===================== MODELS =====================

model User {
  id           String     @id @default(uuid())
  name         String
  email        String     @unique
  passwordHash String     @map("password_hash")
  role         Role
  companyName  String     @map("company_name")
  cnpj         String     @unique
  address      String?
  logoUrl      String?    @map("logo_url")
  status       UserStatus @default(PENDING)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  products       Product[]
  demands        Demand[]
  quoteRequests  QuoteRequest[]
  factoryOrders  Order[]        @relation("FactoryOrders")
  supplierOrders Order[]        @relation("SupplierOrders")
  forecasts      DemandForecast[]
  notifications  Notification[]

  @@map("users")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")

  products Product[]

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  supplierId  String   @map("supplier_id")
  categoryId  String   @map("category_id")
  name        String
  description String?
  unit        String
  basePrice   Decimal  @map("base_price") @db.Decimal(12, 2)
  stockQty    Decimal  @map("stock_qty") @db.Decimal(12, 2)
  images      String[]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  supplier       User             @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  category       Category         @relation(fields: [categoryId], references: [id])
  orderHistories OrderHistory[]
  forecasts      DemandForecast[]

  @@index([supplierId])
  @@index([categoryId])
  @@index([name])
  @@map("products")
}

model Demand {
  id          String       @id @default(uuid())
  factoryId   String       @map("factory_id")
  productName String       @map("product_name")
  quantity    Decimal      @db.Decimal(12, 2)
  unit        String
  neededBy    DateTime     @map("needed_by") @db.Date
  conditions  String?
  status      DemandStatus @default(OPEN)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  factory       User           @relation(fields: [factoryId], references: [id], onDelete: Cascade)
  quoteRequests QuoteRequest[]

  @@index([factoryId])
  @@index([status])
  @@map("demands")
}

model QuoteRequest {
  id         String      @id @default(uuid())
  demandId   String      @map("demand_id")
  supplierId String      @map("supplier_id")
  status     QuoteStatus @default(PENDING)
  createdAt  DateTime    @default(now()) @map("created_at")

  demand   Demand         @relation(fields: [demandId], references: [id], onDelete: Cascade)
  supplier User           @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  response QuoteResponse?

  @@index([demandId])
  @@index([supplierId])
  @@index([status])
  @@map("quote_requests")
}

model QuoteResponse {
  id             String   @id @default(uuid())
  quoteRequestId String   @unique @map("quote_request_id")
  unitPrice      Decimal  @map("unit_price") @db.Decimal(12, 2)
  totalPrice     Decimal  @map("total_price") @db.Decimal(12, 2)
  leadTimeDays   Int      @map("lead_time_days")
  conditions     String?
  createdAt      DateTime @default(now()) @map("created_at")

  quoteRequest QuoteRequest @relation(fields: [quoteRequestId], references: [id], onDelete: Cascade)
  order        Order?

  @@map("quote_responses")
}

model Order {
  id              String      @id @default(uuid())
  quoteResponseId String      @unique @map("quote_response_id")
  factoryId       String      @map("factory_id")
  supplierId      String      @map("supplier_id")
  status          OrderStatus @default(CONFIRMED)
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  quoteResponse QuoteResponse @relation(fields: [quoteResponseId], references: [id])
  factory       User          @relation("FactoryOrders", fields: [factoryId], references: [id])
  supplier      User          @relation("SupplierOrders", fields: [supplierId], references: [id])
  histories     OrderHistory[]

  @@index([factoryId])
  @@index([supplierId])
  @@index([status])
  @@map("orders")
}

model OrderHistory {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Decimal  @db.Decimal(12, 2)
  period    DateTime @db.Date
  createdAt DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([productId, period])
  @@map("order_histories")
}

model DemandForecast {
  id                String   @id @default(uuid())
  factoryId         String   @map("factory_id")
  productId         String   @map("product_id")
  forecastDate      DateTime @map("forecast_date") @db.Date
  predictedQuantity Decimal  @map("predicted_quantity") @db.Decimal(12, 2)
  horizonDays       Int      @map("horizon_days")
  modelVersion      String   @map("model_version")
  createdAt         DateTime @default(now()) @map("created_at")

  factory User    @relation(fields: [factoryId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([factoryId, productId])
  @@map("demand_forecasts")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  body      String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}
